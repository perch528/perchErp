<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 与Python后端交互</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-8">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">
            <i class="fa fa-lock text-blue-500 mr-2"></i>用户登录
        </h2>

        <!-- 登录表单 -->
        <form action="/login/" method="post" id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-gray-700 mb-1">
                    <i class="fa fa-user text-blue-500 mr-1"></i>用户名
                </label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="请输入用户名"
                    required
                >
            </div>

            <div>
                <label for="password" class="block text-gray-700 mb-1">
                    <i class="fa fa-key text-blue-500 mr-1"></i>密码
                </label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="请输入密码"
                    required
                >
            </div>

            <!-- 错误提示 -->
            <div id="errorMsg" class="text-red-500 text-sm hidden"></div>

            <!-- 登录按钮 -->
            <button 
                type="submit" 
                id="loginBtn"
                class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors duration-300 font-medium flex items-center justify-center"
            >
                <i class="fa fa-sign-in mr-2"></i>登录
                <span id="loading" class="hidden"><i class="fa fa-spinner fa-spin ml-2"></i></span>
            </button>
        </form>
    </div>

   <script>
        // 等待页面加载完成
        $(document).ready(function() {
            // 监听表单提交事件
            $('#loginForm').submit(function(e) {
                e.preventDefault(); // 阻止表单默认提交

                // 获取表单数据
                const username = $('#username').val().trim();
                const password = $('#password').val().trim();

                // 简单验证
                if (!username || !password) {
                    showError('请输入用户名和密码');
                    return;
                }

                // 显示加载状态
                showLoading(true);
                clearError();

                // 发送Ajax请求到后端
                $.ajax({
                    url: '/login',
                    type: 'POST',
                    contentType: 'application/x-www-form-urlencoded',
                    data: {
                        username: username,
                        password: password
                    },
                    // 不自动跟随重定向
                    followRedirects: false,
                    xhrFields: {
                        followRedirects: false
                    },
                    complete: function(xhr) { 
                        showLoading(false);
                        
                        // 打印调试信息（关键排查步骤）
                        console.log('响应状态码:', xhr.status);
                        console.log('重定向地址:', xhr.getResponseHeader('Location'));
                        
                        // 处理303重定向
                        if (xhr.status === 303) {
                            const redirectUrl = xhr.getResponseHeader('Location');
                            if (redirectUrl) {
                                // 强制跳转（添加延迟确保浏览器处理完成）
                                setTimeout(() => {
                                    window.location.href = redirectUrl;
                                    // 双重保险：如果第一次跳转失败，1秒后再试一次
                                    setTimeout(() => {
                                        if (window.location.pathname !== redirectUrl) {
                                            window.location.href = redirectUrl;
                                        }
                                    }, 1000);
                                }, 100);
                                return;
                            } else {
                                showError('未获取到跳转地址，请重试');
                            }
                        } 
                        // 处理可能的302重定向（备用逻辑）
                        else if (xhr.status === 302) {
                            const redirectUrl = xhr.getResponseHeader('Location');
                            if (redirectUrl) {
                                window.location.href = redirectUrl;
                                return;
                            }
                        }
                        // 处理其他状态码
                        else if (xhr.status === 200) {
                            // 特殊情况：如果后端直接返回200而不是重定向
                            window.location.href = '/home';
                        } else {
                            showError('登录失败，状态码: ' + xhr.status);
                        }
                    },
                    error: function(xhr, status, error) {
                        showLoading(false);
                        console.error('请求错误:', status, error);
                        showError('登录请求失败，请检查网络连接');
                    }
                });
            });

            // 显示错误信息
            function showError(message) {
                $('#errorMsg').text(message).removeClass('hidden');
                // 错误信息3秒后自动隐藏
                setTimeout(clearError, 3000);
            }

            function clearError() {
                $('#errorMsg').text('').addClass('hidden');
            }

            function showLoading(show) {
                if (show) {
                    $('#loading').removeClass('hidden');
                    $('#loginBtn').prop('disabled', true);
                } else {
                    $('#loading').addClass('hidden');
                    $('#loginBtn').prop('disabled', false);
                }
            }
        });

    </script> 
</body>
</html>
    